# ascfix Development Status â€” 2026-02-06

## ğŸ¯ Project Overview

**ascfix** is an automated ASCII diagram repair tool for Markdown files. It normalizes misaligned boxes, arrows, and text rows generated by LLMs.

**Status:** Core infrastructure complete. Layout normalization 33% done.

---

## âœ… Completed Work

### Phase 1: Foundation & CLI (11 tests)
- [x] Cargo project with strict Clippy linting
- [x] CLI argument parsing (clap)
- [x] File I/O safety (read/write Markdown)
- [x] Main processor pipeline
- [x] Round-trip file preservation

**Files:** `src/cli.rs`, `src/io.rs`, `src/processor.rs`

### Phase 2: Markdown Parsing (30 tests)
- [x] Code fence detection (``` and ~~~)
- [x] Diagram block extraction
- [x] 2D grid representation
- [x] Grid rendering (with exact layout preservation)
- [x] Idempotent grid round-trips

**Files:** `src/parser.rs`, `src/scanner.rs`, `src/grid.rs`

### Phase 3: Primitive Detection (31 tests)
- [x] Box detection (flood-fill algorithm)
- [x] Box content extraction
- [x] Horizontal arrow detection (â†’ â† â”€)
- [x] Vertical arrow detection (â†“ â†‘ â”‚ â”ƒ)
- [x] Unified primitive inventory

**Files:** `src/primitives.rs`, `src/detector.rs`

### Phase 4: Normalization â€” Cycles 1-2 (10 tests)
- [x] Box width normalization (expand to fit content)
- [x] Horizontal arrow alignment (sort by position)

**Files:** `src/normalizer.rs`

---

## ğŸ”„ In Progress

### Phase 4: Normalization â€” Cycles 3-6 Remaining

#### Cycle 3: Vertical Arrow Alignment
- [ ] Implement vertical arrow column alignment
- [ ] Ensure arrows maintain alignment with boxes
- [ ] Handle arrows between multiple boxes
- [ ] Tests for vertical alignment patterns

#### Cycle 4: Interior Padding Normalization
- [ ] Enforce 1-space padding from box borders
- [ ] Adjust text rows to respect padding
- [ ] Verify no content truncation
- [ ] Tests for padding consistency

#### Cycle 5: Rendering Repaired Diagrams
- [ ] Create `src/renderer.rs` module
- [ ] Implement `render_diagram()` function
- [ ] Convert normalized primitives back to grid
- [ ] Verify pixel-perfect placement

#### Cycle 6: Idempotence Verification
- [ ] Implement idempotence check
- [ ] Test processing output twice produces same result
- [ ] Tests on real AI-generated examples

---

## ğŸ“‹ Remaining Work

### Phase 5: Integration & Mode Implementation (Est. 5 cycles)
- [ ] Implement `safe` mode (Markdown table normalization)
- [ ] Implement `diagram` mode (full primitive detection + repair)
- [ ] Implement `check` mode (validate without modifying)
- [ ] Golden file testing framework
- [ ] Real example validation

**Deliverables:** `src/modes.rs`, `tests/golden/`

### Phase 6: Finalization (1 cycle)
- [ ] Quality control review
- [ ] Security audit
- [ ] Code archaeology removal (remove phase markers, TODOs)
- [ ] Documentation polish
- [ ] Final verification

---

## ğŸ“Š Current Metrics

| Metric | Count |
|--------|-------|
| Total Tests | 91 |
| Pass Rate | 100% |
| Clippy Warnings | 0 |
| Production Modules | 9 |
| Test Modules | 4 |
| Lines of Code | ~3000 |

### Module Breakdown

| Module | Purpose | Tests |
|--------|---------|-------|
| `cli.rs` | Argument parsing | 4 |
| `io.rs` | File I/O | 5 |
| `processor.rs` | Main pipeline | 2 |
| `parser.rs` | Markdown parsing | 7 |
| `scanner.rs` | Block extraction | 8 |
| `grid.rs` | 2D grid | 14 |
| `primitives.rs` | Data types | 8 |
| `detector.rs` | Primitive detection | 31 |
| `normalizer.rs` | Layout repair | 10 |

---

## ğŸš€ Next Steps (Priority Order)

### Immediate (Phase 4 Completion)
1. **Cycle 3** â€” Vertical arrow alignment (~2 hours)
   - Implement `align_vertical_arrows()`
   - Add 5-7 test cases
   - Verify Clippy clean

2. **Cycle 4** â€” Interior padding (~2 hours)
   - Implement `normalize_padding()`
   - Add 5-7 test cases

3. **Cycle 5** â€” Rendering (~3 hours)
   - Create `renderer.rs`
   - Implement `render_from_primitives()`
   - Add 5-7 test cases

4. **Cycle 6** â€” Idempotence (~2 hours)
   - Implement `is_normalized()`
   - Add 5-7 test cases
   - Verify with real examples

### Short-term (Phase 5)
5. **Implement modes** (~8 hours)
   - Safe mode: Markdown table normalization
   - Diagram mode: Full pipeline
   - Check mode: Validation only

6. **Golden file testing** (~4 hours)
   - Create test fixtures directory
   - Add 5-10 real AI-generated examples
   - Implement golden file comparison

### Final (Phase 6)
7. **Finalization** (~3 hours)
   - Code review as if shipping
   - Security audit
   - Remove all development artifacts
   - Polish documentation

---

## ğŸ—ï¸ Architecture Overview

```
Input (Markdown)
    â†“
Parser (detect code fences, extract blocks)
    â†“
Scanner (identify diagram boundaries)
    â†“
Grid (2D character representation)
    â†“
Detector (find boxes, arrows, text)
    â†“
Normalizer (expand widths, align arrows, pad)
    â†“
Renderer (convert primitives back to grid)
    â†“
Output (Markdown)
```

---

## ğŸ’¡ Design Principles

### Conservative Detection
- Only recognize well-formed structures
- If ambiguous, leave unchanged
- Better to miss something than corrupt it

### Exact Preservation
- Preserve byte-for-byte outside diagrams
- Maintain exact spacing and formatting
- No content loss or rewording

### Idempotency
- Running twice produces identical output
- Detection handles already-normalized diagrams
- Rendering produces consistent results

### Type Safety
- Full type safety with Rust
- No `unwrap()` on untrusted input
- Proper error handling with `Result`

---

## ğŸ” Testing Strategy

### Test Levels
1. **Unit Tests** â€” Function-level (91 tests)
2. **Golden File Tests** â€” Real examples (Phase 5)
3. **Integration Tests** â€” Full pipeline (Phase 5)
4. **Idempotence Tests** â€” Double-run verification (Cycle 6)

### Test Coverage by Phase
- Phase 1: CLI, I/O, basic pipeline
- Phase 2: Parser, scanner, grid round-trips
- Phase 3: Detector for all primitives
- Phase 4: Normalization operations
- Phase 5: Mode behavior, real examples

---

## ğŸ“Œ Known Issues / Considerations

### None currently
- All tests passing
- No Clippy warnings
- No security concerns identified
- No performance issues detected

---

## ğŸ“ Development Notes

### TDD Discipline
Each cycle follows: RED â†’ GREEN â†’ REFACTOR â†’ CLEANUP
- RED: Write failing test
- GREEN: Implement minimal code
- REFACTOR: Improve design
- CLEANUP: Lint, format, document

### Code Quality Standards
- Strict Clippy linting (all = deny, pedantic = deny)
- No unsafe code (forbidden)
- Comprehensive test coverage
- Clear error messages

### Commit Pattern
- One commit per cycle
- Includes cycle number and phase
- Lists changes and verification
- Co-authored credit included

---

## ğŸ”„ Git History

```
3cceddf (HEAD) feat: Phase 4 - Layout normalization (cycles 1-2)
ebcbd61        feat: Phase 3 complete - Primitive detection (cycles 4-5)
5bcaabe        feat: Phase 3 - Primitive detection (cycles 1-3)
0f7511e        feat: Phase 2 - Markdown parsing and grid representation
c75c403        feat: Phase 1 - Foundation and CLI setup
```

---

## ğŸ“ Questions / Decisions

### None pending
All design decisions documented in phase files and code comments.

---

## ğŸ‰ Summary

**What's Working:**
- Full CLI with multiple modes
- Markdown parsing and grid representation
- Comprehensive primitive detection
- Basic layout normalization
- Excellent test coverage (91 tests, 100% pass)

**What's Left:**
- Complete layout normalization (4 remaining cycles)
- Implement modes and integration (Phase 5)
- Final cleanup and documentation (Phase 6)

**Estimated Remaining Time:**
- Phase 4 completion: ~9 hours
- Phase 5: ~12 hours
- Phase 6: ~3 hours
- **Total: ~24 hours**

**Ready for:**
- Next development session
- Code review (Phase 1-3 are stable)
- Integration testing (Phase 4 completion needed first)

---

## ğŸ“… Timeline

- **2026-02-05** â€” Completed Phases 1-3, Started Phase 4
- **2026-02-06** â€” Completed Phase 4 Cycles 1-2
- **Next** â€” Phase 4 Cycles 3-6 (target: complete before Phase 5)
- **Final** â€” Phase 5-6 for full feature completion

---

Generated: 2026-02-06
Last Updated: End of Phase 4 Cycle 2
Next Review: After Phase 4 Completion
